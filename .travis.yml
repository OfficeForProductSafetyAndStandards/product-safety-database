sudo: required

language: generic

services:
  - docker

branches:
  only:
    - master
    - staging
    - prod

cache:
  directories:
    - ~/bundle-cache
    - ~/coverage-cache

stages:
  - Build
  - name: Test
    if: type = pull_request # This is designed to cut out unnecessary runs of the test suite. See PSD-821 for details.
  - name: Update code coverage
    if: branch = master AND type = cron
  - name: Run regression tests
    if: branch = master AND type = cron
  - name: Deploy to staging
    if: branch = master AND type = push
  - name: Deploy to production
    if: branch = master AND type = push

jobs:
  include:
    - stage: Build
      before_install:
        - mkdir -p ~/bundle-cache
        - mkdir -p ~/coverage-cache/psd
      install:
        - DOCKER_ORG=${DOCKER_ORG} BRANCH=${TRAVIS_BRANCH} BUILD_ID=${TRAVIS_BUILD_NUMBER} ./infrastructure/ci/build-docker-images.sh

    - stage: Test
      name: PSD Tests
      script: COMPONENT=psd-web ./infrastructure/ci/test-if-changed.sh
      env: &test_env
        - COVERALLS_PARALLEL=true
    - name: PSD Static Analysis
      script: COMPONENT=psd-web ./infrastructure/ci/static-analysis-if-changed.sh

    - stage: Deploy to staging
      name: Deploy PSD web
      script: COMPONENT=psd-web DOCKER_ORG=${DOCKER_ORG} ./infrastructure/ci/travis-wait.sh ./infrastructure/ci/deploy-if-changed.sh
      env: &deploy_staging_env
        - SPACE=staging
        - BRANCH=${TRAVIS_BRANCH}
        - BUILD_ID=${TRAVIS_BUILD_NUMBER}
        - CF_STAGING_TIMEOUT=30 # Extend CF staging timeout to 30 minutes
        - secure: "Y0akVovVveSyq+Ws1ZDAq23wLSf4YSOXZ2wKRdJvn8iK5XX5L/x37pFbK0ZurCwAYoXNLH/KB6aq3buFdoUdVM/bIlyx6bXCkeaLa8qXJBqUGMgFfvC0EoOp1LQxOoEkW1nEAS3DFs9Fhh1MiGh+3qY9bJ59Ed8KG5rG3A8AZzb+s0bBU9MIjr9WOeGSkzP6OlULpclWD3Q+S58lsvK/6IZ6/xwFFISs4L/kDYYkn5HX+gHOz13BM/ztSZBcD2hULUcrKql9355E8Fgbuga3DDFgVv0csRwQKF30g2gp7Ae48agWZQBFAAjjHjLy+Z6ZLejklSPAjx2m7TZV1kaRDvkO1zqzvutQ2iIb2IufLwat65rVPwZKj0sFTBMv7xebBVhDNv661uaBd53yPQ6idLf0mnHvvbAEoUKGb+A/UYmA/I4lEW5ifDtpeG5PYQWtaDuaFZC+QpzwwYUEI6yO4znUDLOFvy+jYOWESTBD/snfmKHhFYE/4GmZZkQdIzhtqkIVcG5kxEYYNqtDF/OaaOHqRLM4Bk5HEsnVO7bFCAuY0/mVAd55Pe3uE/llk4pa0yKO23uUNvyLY+fDW5mWUvyiXdd/FDE9B2JSR/SoS7l86FOmxvcA2Bq8PDBjljd988VYDJ7u89oRc/idwyOJ3Z4JEgqIMykTvJYhgPeNRQw=" # CF_USERNAME
        - secure: "xakLUBW+GLK+Lj5JT51iCa8PPmx6s0aZGlPKHovrbcAZHXbejhRiQiuK6KUv6VC1+ozQtaJOsboTwMz2rY63YMtzZ79wB8I4ZO21+NDfmkk6JTYxAy6+4CilyPgu6EGczRh7VoJ+zcvDBkN/egm0dNvfEyX/5SXtnbgIew1lxkbPYMD1TF5YCV7wUFVDBCIWKG7WMlgqHTUIBQ9FtUpFNq9b55nD61/FqJi/q7dCb//NDoopcQp636t6nJ6OO6vbIPA34jYK2IUjlhpyqaNPFG1agOOQxt738nwxqWvi+zJevGsgU0T26j76+GQxCWz4LAkdjZ4H6DhchasUTGkgdH4f5xSS44BpNChXyaMvaA9E9WewZO2epSQIV3TxWAlNv6cwBnf3O64yiVXd5iPA140nQyF3Q6BSAjQokuBn4dCf1o87wsWPz3t8ehQmtOnJAyvW4SvwluQOVjjT5Cc7nFQpKiy9piizp+J77fGV/X8Y+LwjIeSWoY2fyRY0eWDY6d6jPomSeLWQG1ZNDIC0g5KTBA69o8PB5xNdenXcUb3qnmHKoC7OQ2rurCsf6HDTCUT/5Q4Go984cWkwV8kf8pRDDTNxsD5BuYdULbDoezYwnKB14VlKbTdAhV150NzHR8v8SYWueLQoZFwmMsN8Baxe3ch8xVNudMLcCxkP9To=" # CF_PASSWORD
        # - secure: fMxdrVkJwKQrlszdq5lRMvUrmkYuHEJwIcmA8cWh8TeLak5m7t+EQgbEX/4DjpOclKWtd0/p80JaO36aVpkkMoTgQ/JW3q9vWpGaP2w4uLSfd6A+32ltgQCtpyO0dAeUXE1X5eY10oBwAsKydMZtMecE1dFPkBtcbY0U0no744Pf4yMOOa/V4iiD3RBB/ZRDSSGou2bkLdXDzgbjDLuugP4qmmnuS2IMzsrJpFtqh8aDGZd2vtCRiS3niKCshIUN/9/YX60lQi3b9BU1ZIS4Wz8LrYXPBhJBbRgZOYJ4qBoq0lUNdPkGKbtWt2qDGs6tJJ/LKqjLcAAa1ONgdhwy+q+C+5+fg1jHD8bN7hPcp+Smh5cuAg8oznHf+XdV9ZO+R3XudvGyehJxyNGRGAyJLbOlaK0eERQVDruNRFXoqerrnaI6v1LV4IZ1JQTdptGqDEegGIXk0sddgImovkVAkFwcNSq7crU/NbnCbCvy3kDXrd7nRIzso08V9I5Tcj13K2CjVhJE9Z1VNIZCx3ScUmnqS+1QvuJzJZEup2i7Z55CzXBxWJD9thIIden/4wvfiW6DpO+kEIbWMx30Jviri1jdfs+GtvUhapYw1oHEbMV9hwNRh+JjbI6T18UDwE3qHlDNqSjI/AWPt7oaMlMdySjkcoYRu2SHkKpivkFIeho= # PSD_BASIC_AUTH_USERNAME
        # - secure: fCxsuNP1V7vOTBd5qUUApHYFz9Tt5YbS0j4DeaqWITx+l2axK9dS2hRVOw50ozNH7z1HOINfh6HeT5jhC+QkCsfSfUUQW6anQ5Edk+7qOHQrEXw6yd4EeotRU1WZT9cRyYFHDDoBru0wY97oMdZwnUg9uZt7+ESQbhywPS/dZzjG1ldnoaZ0VwJ6GUZQQG1xdYwVuXgpCuNgcjrDit2Qa+TUJtnYiee5F+tmit5ZLlKhrRaCfKvPVDtv+J+KtYD2MyXwlgf6Xntp/5miEIg2gjyeaCK1LrTXjHgChyit5NzFu2lfY0VQFZX+H2c8RAH12Oqx2Bvri5cZJj8X+Q+sSJnsK5YuJjbP1He3rsqsvZsl/XWHBNp/PCCPNpQtWrClN4H0AlorboNhLkGpohZwC1/o/m6+GkvvFcLJ1WkSkjBMjyP0RCRjMQ2oZdfickAlisTTHRr6WUM6IXmx8AiEK5iLx9P47/ODNrUuh9BiJ6NMf3bhzsi1rsrz/d8Ycvwa/Hq8jL7Sz349iNvpil64VV9MQ9Earwjgp+Ned2dbpvhdwnAWm1HnZH7MyT/LoQBZntVWaegXJ7AKkA66/CMyhBRgBnwyLssh/TFhtL0q2LqAQ2zrhxj4OT+u5TrzewDi6kKhMTYmGr+paztVF/T7b6PTMhry1c1bDy8oX5bOIks= # PSD_BASIC_AUTH_PASSWORD
    - name: Deploy PSD worker
      script: COMPONENT=psd-worker DOCKER_ORG=${DOCKER_ORG} ./infrastructure/ci/deploy-if-changed.sh
      env: *deploy_staging_env

    - stage: Deploy to production
      name: Deploy PSD web
      script: COMPONENT=psd-web DOCKER_ORG=${DOCKER_ORG} ./infrastructure/ci/travis-wait.sh ./infrastructure/ci/deploy-if-changed.sh
      env: &deploy_prod_env
        - SPACE=prod
        - BRANCH=${TRAVIS_BRANCH}
        - BUILD_ID=${TRAVIS_BUILD_NUMBER}
        - CF_STAGING_TIMEOUT=30 # Extend CF staging timeout to 30 minutes
        - secure: "ws4Yg7RaOigCBEyUQLNCE+K054AT7sIPRVlKTXzKCqIeRht0iQMqaUg/YzzskB7IQDO6TO6utPgO4dufB/4vsHh2LejRtkhFqCjAvD2qZ3rzSZwtArv+gslfzcu3EeftjqcX9zuszhPapneHzPMf3lsmHATjB4S1foNAFlrPFs4ppxGxAHn5SUtuh+PM91LBnvFPibbJ9dK9PONvYmYmrX8VW1bgOrYQUhNd+0gjxWE6w99ijpDA58839qfbwvjXqc0d3Zl7c85h25vTYUuTYINv1/zuxQjlhBNLYvZsQT6kX0RrlKs2uqhYus7jCg7fJnr7yhahVvxQPLH9ngTOQ3bxUIpqOwzwqF1807HoiDmUTp4kTeQnpQSqkswY+CGQtaNXzC7Zg1Y33N6J76KgJjsbkIV+MZg76wtD1tnNhIAtZR5PI7/EHRhicPHVT/KG5Ziu6WNSCidF+ocZhcovnjIB0JUFaiVCdA7/CZ8tD/paoVSGW+xoISkrNgK5+ERDFSPdg2PR3Ms0RS2jNA3QARJ8SPEfizDrCeoth+l/mkw0NoaXQSFQDDoFdengGG9wEGF2xtJ4xmGzc+Vpi9YDJbqHvxM1GOd2JMcfdvi/KlDvbJLU/KNiqQvtqxV+WKuI5hfRyRTOBTn8eZiSB73cbwkEfaCfdh2tFxqaovL/PZw=" # CF_USERNAME
        - secure: "cOZpThcI3ShvLdM3mHQTynMHIOHvTZEJ9ecGOmbc/tTKstsWEVD1TJ8PH4YqPBncyysyK6NHDoUfZE1tTobH+3F2HVAuJnPmgKQ4cN9d9yKxLWnFYNtYWaUS0QXkhuHg6bkFX2NnE2/Wlz3CtqeQ+4z2otSymc/bT9OwWMhsLo/eWP3Nu+++KboIB9v5h9cQWGHLBiNUWdMNlWgzuKLttOIlscKKS6cFY31rAL1C0q9YJi6zkqJ4zZfRn9U4CJmELfNPLdVjwc//Rfj0LnUW0GeKhR6ua2fnwoEmwWsylwqI6nR4SrXKRA+RNoQkdhEOfir4Y6wrlxuNenhDYTi2oJlg795d+FntsN/On82vn3oUvQ2ZY5bcp6955b4px0miUeKo8I7LhRvfsiPWy9n+EvbEN7cTo0eVcqKl7xZeTIOooSAjUWQ+nyt+Y7CgIrzk3RpBPDGS5N6dl+q+weZayo2VJrXUBzxY0cxPmqiRyQXvibAMtQjWROHtV4+t5IvJ7HqpQxswBjxFqTdFNN+dGMqfBkbgHpj61u3K+VLF8hR1eqh6+y9gP/jA5ovG1OmN6VV3XX99xlSeDEn952pn6GA7kdSuW0Y9YYkmW2YSOZlJBVEtdRL35ekKYlcZ9sjvfIlXnWgQPZImK4ZcAhoYxxw4x7kwyXx0UEQr428a2jI=" # CF_PASSWORD
    - name: Deploy PSD worker
      script: COMPONENT=psd-worker DOCKER_ORG=${DOCKER_ORG} ./infrastructure/ci/deploy-if-changed.sh
      env: *deploy_prod_env

    - stage: Update code coverage
      name: PSD coverage
      script: COMPONENT=psd-web ./infrastructure/ci/update-code-coverage.sh
      env: COVERALLS_PARALLEL=true

notifications:
  webhooks: https://coveralls.io/webhook

env:
  global:
    - DOCKER_ORG=beisopss
    - secure: "YOS5LC36OH28/cR8rTcm6bb5//D/rm65SGQZAIUL/mitJZE/0JzGwKy92Cr9reY3YO2zEV0RBlTjen3EPA4hBsE1mJE1DS8KLCeDYVefGuBIjsEYCp9s7RY85hIG8G81YOwkk/GYIPkd6x3qCVuKuRRdQhtRWn6SSdvEhZSO9lWTcXCvgb+8YeA17QxcXq8J9nDg7piqKDiTegU3wl2EDgpJE1/hurpys2d+ToKq8vzGwTumj0gwLX2j38mRhZgvXbasIZY913xg5SveoGKXvk4ikH/GIOprbww9obQpXoPVS04gR5TLsQuHY0OAKYSYECQxaVCjHfS/J4VrhJ7nzbVY7v+4ERXh6sBPZEN0hfx9K06d9UTYseIVYBrBCTX/MPgRO69wiSM6pSvicxD6UoYbn6QLSaYrKqusRhR8PMK7xo/udRo6NsLADFWDBoOVEWD7wU3eYovRkwXqHqnJ0oQwIoQDR8F4K0rGM4cmhVnuw9E43/N0Ng5uAig/WCIMNhn7DZXDbU+9bflx34eDLWyMKiWxWKD8/fLqYgDO37UZfSTV0XNW7TA5t1+Ah6jhfpGMFBgfrjQFlLXhMxc3utdf2Ijw1DM6QbNl3fIm0HHT71tl/U4KDNnhRjl9jM7wKh4rmXLFHyUy3jphIrFyKAENlmviVgBzfNdK5cAPn/E=" # DOCKER_USERNAME
    - secure: "ErdNKKHtFTN7gpHdAdU3V7utTeWJ08jgClVQiego0bYi55fSbwKpECGOABRyDIZH79X9r6qdRTHp2tg5Q4hCn1677j/O56XtMWVWaQBZk5vGRVUydbqZhPFgSah6jX6VUGpkxRaLwc+Z+RmpaZLLiXY/6g72UpegM0k2nxvpSeZKhc0sZ2+XO+UR/6LQ+9BZTtUPCbYfzPWyAkXaDZi4mPhQzZVLDpVcWTkHch0K1bBPeCkgDgi6Lm4vqd7uthy1MrczTww0QhZ2lkZEiniePgXkhm/xEBSLRoTXt0bCYEDxGpx5lcJoCQ1h5TOMmrQwNGkqX+aZxvcngC+lrGfFFLYCGHinr6vE3G6fDmXZGdJ+A1Ms8lbIGMG763LUcm9wmqWjDwW+g7KNFgUYyXDOC1sWVLCUkEKelkcpLsaFnA56A+kNC9ozSZJGNoXxS1ZZ9e0ioaRsEOhuIpvKehtt60aO4rtDDJRO2oAa4F3pc+CJHZgpzLnkCsOlDTMSD/XP1CKk/27+Qs402B8SdKy5+qVf9WbrqwJ2/mbw7Xg4CCf977EpY5KDxrGIB7TS99EbbbqNdrvIC+ol3A9pw8wc2G5PAU1OoNriDa8NaL2veW/D3N+sk1O1WFdZtoG6yR5zdt009TTnYOgU2InfSgkhfZlOxLCVuTG7h/UlOWbg5IE=" # DOCKER_PASSWORD
    - secure: "mpUgdDSPTRtgppkrYbcYYuDwRM1eAs1pBtL4PWI3ss3swA4uIGwALUOC+PB2HKqJ28SStTePgSYMpCiZNrV7yLdlPmM2VbTdyD9Fa0lInPeiCjAkvwduVmCft/n6OQKEZKAuCukajVsdVz/7pCwMj/AIJYYd7sYSLcNYrEEVzzgwTe2AfLM28098s5Tczz3Yqbm7WRcDPTJLXh9k0Htj41AzkXNZHGR1yCT8jkVHpbyPM+KXy0Ci71ImcqJ4ksBVy9Lh0HkUYFyaKlUcVh+iLzD8DDkBNuL9E/PMvp1hpl+31ClDgIXNxr17nUf8oO0DNKvX6gMs5KNVCdXtpEkhQoVDpUcBAr9nNHUf+X4vejgHfMcn+0ptdfRDrCsfHe6b1hThdWTZ0SKcX8i2e5RHDlJPYT5JwqPbb1C6v0mWsaQiyLz+rvLz8bH9Cj9Jk/tG/6HyHsVX9MfStpsYQnL6bckY7+GUd786XS1KCOpuXHwMouunJiEhTTHVEQtqEDLSSJgE9iZ+7VcJlVXx9BdCIBawKsT/qqvuSEVOx3CunKCiBsr+M4HMDw3LqDQgdT1pB6QKFtGsZqaIPuE4+tA7GOeJb4SM35UhXOMR9K4GOJAHRmTBahn1+2UPl1hrCoK4JMdHs2Zm84NkE4LRcFTy2crfmLMsa5wMVz1MTdFw6fI=" # NOTIFY_API_KEY
