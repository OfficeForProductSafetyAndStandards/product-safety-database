<%= page_title "Product - #{@product.name}" %>

<% content_for :after_header do %>
  <%= govukBackLink href: all_products_path, text: "Back" %>
<% end %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-three-quarters opss-desktop-min-height--s">
    <span class="govuk-caption-m">&nbsp;</span>
    <h1 class="govuk-heading-l govuk-!-margin-bottom-3">
      Product <span class="govuk-!-font-weight-regular govuk-!-font-size-27 govuk-!-margin-left-2"><%= @product.psd_ref %></span>
    </h1>
    <p class="govuk-body opss-secondary-text">This is a Product Safety Database (<%= psd_abbr title: false %>) product record.</p>
  </div>
  <div class="govuk-grid-column-one-quarter govuk-!-margin-bottom-4">
    <div class="opss-text-align-right">
      <% if policy(@product).update? %>
        <%= link_to "Edit the product record", edit_product_path(@product), class: "govuk-link govuk-link--no-visited-state govuk-!-font-size-19 opss-text-underline-offset" %>
      <% end %>
      <span class="govuk-visually-hidden">|</span>
      <% if policy(@product).can_spawn_case? %>
        <%= link_to new_investigation_ts_investigation_path(product_id: @product.id), class: "govuk-link govuk-link--no-visited-state govuk-!-font-size-14 govuk-!-text-align-centre govuk-!-padding-2 govuk-!-display-inline-block govuk-!-margin-top-4 govuk-!-margin-bottom-6 govuk-link--no-underline opss-border-all opss-float-left--mobile" do %>
          Create a new case<br class="opss-br-desktop"> for this product
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<div class="govuk-grid-row">
  <%= render "sub_nav", product: @product %>

  <section id="page-content" role="region" class="govuk-grid-column-three-quarters">
    <h2 class="govuk-heading-m govuk-!-margin-top-1 govuk-visually-hidden">The product record</h2>
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <h3 class="govuk-heading-m"><%= @product.name %></h3>
      </div>
    </div>

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <%= @product.overview_summary_list %>
      </div>
      <% unless @product.virus_free_images.empty? %>
        <div class="govuk-grid-column-one-third">
          <figure class="opss-margin-bottom-1-desktop">
            <%= image_tag @product.virus_free_images.first.variant(resize_to_limit: [300, 500]), class: "opss-details-img opss-details-img--thumbnail opss-float-right-desktop" %>
            <figcaption class="govuk-visually-hidden"><%= @product.images.first.title %></figcaption>
          </figure>
        </div>
      <% end %>
    </div>

    <h4 class="govuk-heading-m govuk-!-margin-bottom-1 govuk-visually-hidden">Product details</h4>

    <%= @product.summary_list(params[:timestamp]) %>

    <%= govukAccordion id: "product-accordion", classes: "govuk-!-margin-top-9 opss-accordion--sm-all", items: [
      {
        heading: {
          html: "Images <span class=\"govuk-!-font-weight-regular govuk-!-font-size-19\">(#{ @product.virus_free_images.size })</span>".html_safe
        },
        content: {
          html: render("products/tabs/images")
        }
      },
      {
        heading: {
          html: "<span class=\"govuk-visually-hidden\">Related</span> Cases <span class=\"govuk-!-font-weight-regular govuk-!-font-size-19\">(#{ @product.unique_investigation_products.size })</span>".html_safe
        },
        content: {
          html: render("investigations_summary", investigations: @product.unique_investigation_products.map(&:investigation))
        }
      }
    ] %>

    <% if @product.owning_team.nil? %>
      <% if policy(@product).update? %>
        <p class="govuk-!-font-size-14 govuk-!-margin-bottom-1 opss-secondary-text opss-text-align-right">
          To edit the details for this product go to the full <%= link_to(product_path(@product), class: "govuk-link govuk-link--no-visited-state") do %><span class="govuk-visually-hidden"><%= @product.psd_ref %></span> product record page<% end %><span class="opss-hidden-desktop">.</span>
          <br class="opss-br-desktop">
          By editing this product record your team will become the owner of this product record
        </p>
      <% end %>
    <% elsif @product.owning_team == current_user.team %>
      <% if policy(@product).update? %>
        <p class="govuk-!-font-size-14 govuk-!-margin-bottom-1 opss-secondary-text opss-text-align-right">
          This product record is currently owned by your team<span class="opss-hidden-desktop">.</span><br class="opss-br-desktop"> You can <%= link_to "edit the product details", product_path(@product), class: "govuk-link govuk-link--no-visited-state" %><span class="opss-hidden-desktop">.</span>
        </p>
      <% end %>
    <% else %>
      <% if params[:timestamp].blank? %>
        <p class="govuk-!-font-size-14 govuk-!-margin-bottom-1 opss-secondary-text opss-text-align-right">
          You can contact the <%= link_to(owner_product_path(@product), class: "govuk-link govuk-link--no-visited-state") do %><span class="govuk-visually-hidden"><%= @product.psd_ref %></span> product record owner<% end %> with editorial requests,<br class="opss-br-desktop"> amendments, or additional information<span class="opss-hidden-desktop">.</span>
        </p>
      <% end %>
    <% end %>
  </section>
</div>
