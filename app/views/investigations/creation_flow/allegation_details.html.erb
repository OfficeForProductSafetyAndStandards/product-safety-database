<%= page_title @page_title, errors: @investigation.errors.any? %>

<% content_for :after_header do %>
  <%= link_to "Back to cases", investigations_path, class: "govuk-back-link" %>
<% end %>

<%= form_with model: @investigation, scope: :allegation, local: true, url: wizard_path, method: :put do |form| %>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop">
      <%= error_summary(@investigation.errors, %i[description product_category hazard_type]) %>

      <h1 class="govuk-heading-l"><%= @page_title %></h1>

      <%= govukTextarea(
        key: :description,
        form: form,
        attributes: { maxlength: 10_000 },
        hint: { text: "Please give as much detail as possible" },
        label: { text: "What is being alleged?", classes: "govuk-label--m" }
      ) %>
      <%= govukSelect(
        choices: product_categories,
        key: :product_category,
        form: form,
        show_all_values: true,
        is_autocomplete: true,
        label: { text: "Product category", classes: "govuk-label--m" }
      ) %>
      <%= govukSelect(
        choices: hazard_types,
        key: :hazard_type,
        form: form,
        show_all_values: true,
        is_autocomplete: true,
        label: { text: "Hazard type", classes: "govuk-label--m" }
      ) %>

      <div class="govuk-form-group<%= " govuk-form-group--error" if file_validation_errors?(@investigation.errors, attribute: :base) %>">
        <%= govukLabel(
          text: "Are there any files or images related to the allegation?",
          classes: "govuk-label--m",
          for: "allegation_attachment_file"
        ) %>

        <% if @file_blob.present? %>
          <p id="current-attachment-details">
            Currently selected file:
            <%= link_to "#{@file_blob.filename} (opens in new tab)", @file_blob, target: "_blank", rel: 'noopener' %>
          </p>
        <% end %>

        <%= form.fields_for :attachment do |subform| %>
          <%= subform.label :file, "Upload a file", class: "govuk-label" %>
          <%= subform.file_field :file, class: "govuk-file-upload" %>
        <% end %>
      </div>

      <div class="govuk-form-group">
        <%= form.submit "Create allegation", class: "govuk-button" %>
      </div>
    </div>
  </div>
<% end %>
