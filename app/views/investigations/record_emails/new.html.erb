<%= page_title "Record email", errors: @email_correspondence_form.errors.any? %>
<% content_for :back_link do %>
  <%= govukBackLink(
    text: "Back",
    href: new_investigation_correspondence_path(@investigation)
  ) %>
<% end %>

<%= render "investigations/pages_top", investigation: @investigation %>

<%= form_with(model: @email_correspondence_form, local: true, url: investigation_emails_path, method: :post, builder: ApplicationFormBuilder, html: {novalidate: true}) do |form| %>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop">
      <%= error_summary form.object.errors %>

      <span class="govuk-caption-l"><%= @investigation.pretty_description %></span>

      <h1 class="govuk-heading-l">Record email</h1>

      <%= render "components/govuk_fieldset", legend: { text: "Email details", classes: "govuk-fieldset__legend--m" } do %>
        <%= render "form_components/govuk_radios",
                   form: form,
                   key: :email_direction,
                   fieldset: { label: { text: "Email direction", classes: "govuk-visually-hidden" } },
                   classes: "govuk-radios--inline",
                   items: Correspondence::Email.email_directions.map { |value, label| { text: label, value: value } } %>
        <%= render "form_components/govuk_input",
                   key: :correspondent_name,
                   form: form,
                   classes: "govuk-!-width-two-thirds",
                   label: { text: "Name" } %>
        <%= render "form_components/govuk_input",
                   key: :email_address,
                   form: form,
                   classes: "govuk-!-width-two-thirds",
                   label: { text: "Email address" } %>
      <% end %>


      <%= form.govuk_date_input :correspondence_date, legend: "Date sent" %>

      <%= form.govuk_input :overview,
        label: "Summary",
        label_classes: "govuk-label--m",
        hint: "Give an overview of the email",
        classes: "govuk-!-width-two-thirds" %>

      <%= render "components/govuk_fieldset",
                 legend: { text: "Email content", classes: "govuk-fieldset__legend--m" },
                 describedBy: "email-content-hint" do %>

        <span id="email-content-hint" class="govuk-hint">Upload the email as a file, or enter the subject and body below</span>

        <%= form.hidden_field :existing_email_file_id %>

        <div class="govuk-form-group">
          <% if form.object.email_file.present? %>
            <p>
              Currently selected file: <%= link_to form.object.email_file.filename, form.object.email_file, target: "_blank", rel: 'noopener' %><br>
              Selecting a different one will replace it.
            </p>
          <% end %>

          <%= form.govuk_file_upload :email_file,
            label: "Upload a file"
          %>
        </div>

        <%= form.govuk_input :email_subject,
          label: "Subject line",
          classes: "govuk-!-width-two-thirds" %>

        <%= form.govuk_text_area :details,
          label: "Body",
          label_classes: "",
          attributes: { maxlength: 50_000 }
        %>

      <% end %>

      <fieldset class="govuk-fieldset">
        <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
          Attachments
        </legend>

        <div class="govuk-body govuk-hint">
          If you have multiple files, compress them in a zip
        </div>

        <div class="govuk-form-group <%= "govuk-form-group--error" if file_validation_errors?(form.object.errors) %>">

          <% file_upload_field = capture do %>
            <%= form.govuk_file_upload :email_attachment,
              label: "Upload a file"
            %>
          <% end %>

          <%= form.hidden_field :existing_email_attachment_id  %>

          <% if form.object.email_attachment.present? %>
            <p id="current-attachment-details">
              Currently selected file:
              <%= link_to form.object.email_attachment.filename, form.object.email_attachment, target: "_blank", rel: 'noopener' %>
            </p>

            <%= govukDetails(summaryText: "Replace this file", html: file_upload_field) %>
          <% else %>
            <%= file_upload_field %>
          <% end %>

          <div id="attachment-description">
            <%= form.govuk_text_area :attachment_description,
              label: "Attachment description",
              label_classes: "",
              attributes: { maxlength: 10_000 }
            %>
          </div>
        </div>
      </fieldset>

      <%= form.submit "Add email", class: "govuk-button" %>

      <%= permission_notice(text: t("case.protected_details", data_type: "email correspondence")) %>
    </div>
  </div>
<% end %>
