<%= form_with(model: change_case_owner_form, method: :put, url: wizard_path, local: true) do |form| %>
  <%= render "form_components/govuk_error_summary", form: form %>
  <%= yield %>

  <%
    items = @selectable_users.map do |user|
      { text: user.decorate.display_name(viewer: current_user), value: user.id, checked: investigation.owner == user }
    end
  %>

  <% items.unshift divider: "Your team" %>

  <% someone_in_your_team = capture do %>
    <%= render "investigations/ownership/owner_selection",
      form: form,
      key: :select_team_member,
      items: @team_members,
      label: "Select team member",
      show_all_values: true
    %>
  <% end %>

  <% items.push text: "Someone in your team",
               value: "someone_in_your_team",
               conditional: { html: someone_in_your_team } %>

  <% items.push text: current_user.team.name,
                value: current_user.team.id,
                checked: investigation.owner == current_user.team %>

  <% items.push divider: "Other teams added to the case" %>

  <%
    teams = @selectable_teams.map do |team|
      { text: team.decorate.display_name(viewer: current_user), value: team.id, checked: investigation.owner == team }
    end
  %>
  <% items.concat teams %>

  <% items.push divider: "Other" %>

  <% items.push text: @opss_incident_management_team.name,
                value: @opss_incident_management_team.id,
                checked: investigation.owner == @opss_incident_management_team,
                hint: { text: "For reporting serious risks to OPSS" }
                %>

  <% other_teams = capture do %>
    <%= render "investigations/ownership/owner_selection",
      form: form,
      key: :select_other_team,
      items: @other_teams,
      label: "Select other team name",
      show_all_values: true
    %>
  <% end %>
  <% items.push text: "Other team", value: "other_team", conditional: { html: other_teams } %>

  <% someone_else = capture do %>
    <%= render "investigations/ownership/owner_selection",
      form: form,
      key: :select_someone_else,
      items: @other_users,
      label: "Select other user"
    %>
  <% end %>
  <% items.push text: "Someone else", value: "someone_else", conditional: { html: someone_else } %>

  <%= render "form_components/govuk_radios", form: form, key: :owner_id, items: items, classes: "opss-radios__divider--title" %>

  <div class="govuk-form-group">
    <%= form.submit "Continue", class: "govuk-button" %>
    <p><%= link_to "Cancel", investigation_path(investigation), class: "psd-block-link" %></p>
  </div>
<% end %>
