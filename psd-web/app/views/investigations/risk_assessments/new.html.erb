<% page_heading =  "Add risk assessment" %>
<%= page_title page_heading, errors: @risk_assessment_form.errors.any? %>
<% content_for :back_link do %>
  <%= govukBackLink(
    text: "Back",
    href: investigation_supporting_information_index_path(@investigation)
  ) %>
<% end %>

<%= render "investigations/pages_top", investigation: @investigation %>


  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop">

      <%= form_with(model: @risk_assessment_form, local: true, url: investigation_risk_assessments_path, method: :post, builder: ApplicationFormBuilder, html: {novalidate: true}) do |form| %>

        <%= error_summary @risk_assessment_form.errors %>
        <span class="govuk-caption-l"><%= @investigation.pretty_description %></span>
        <h1 class="govuk-heading-l"><%= page_heading %></h1>

        <%= form.govuk_date_input :assessed_on, legend: "Date of assessment", hint: "For example, 31 1 2020" %>

        <%- custom = capture do %>
          <%= form.govuk_input :custom_risk_level,
            label: "Other risk level",
            label_classes: "govuk-visually-hidden",
            classes: "govuk-input--width-20"
          %>
        <% end %>

        <% radio_items = (Investigation.risk_levels.keys - ["other"]).map do |level|
            { text: t("investigations.risk_level.show.levels.#{level}"), value: level }
           end
           radio_items.push(text: "Other", value: "other", conditional: { html: custom })
        %>

        <%= form.govuk_radios :risk_level,
          legend: "What was the risk level?",
          items: radio_items
        %>


        <%- teams_html = capture do %>
          <%= form.govuk_select :assessed_by_team_id, label: "Choose team", items: @other_teams %>
        <% end %>

        <%- businesses_html = capture do %>
          <%= form.govuk_select :assessed_by_business_id,
            label: "Choose business",
            hint: safe_join(["If the business isnâ€™t listed, you should ", link_to("add it to the case", new_investigation_business_path(@investigation)), " first."]),
            items: @businesses %>
        <% end %>

        <%- someone_else_html = capture do %>
          <%= form.govuk_input :assessed_by_other, label: "Organisation name" %>
        <% end %>

        <% assessed_by_radio_items = []

          assessed_by_radio_items.push(text: "Me or my team", value: :my_team)
          assessed_by_radio_items.push(text: "Trading standards or another market surveilance authority", value: :another_team, conditional: { html: teams_html })
          assessed_by_radio_items.push(text: "A business related to the case", value: :business, conditional: { html: businesses_html }) unless @businesses.length == 1
          assessed_by_radio_items.push(text: "Someone else", value: :other, conditional: { html: someone_else_html })

        %>

        <%= form.govuk_radios :assessed_by,
          legend: "Who completed the assessment?",
          items: assessed_by_radio_items
        %>

        <% if @risk_assessment_form.products.length > 1 %>
          <%= form.govuk_checkboxes :product_ids,
            legend: "Which products were assessed?",
            hint: "You must choose at least one. Only products already added to the case are listed.",
            items: @risk_assessment_form.products
          %>
        <% else %>

          <h2 class="govuk-heading-m">Product assessed</h2>

          <p class="govuk-body"><%= @risk_assessment_form.products.first[:text] %></p>

          <%= form.fields_for :product_ids do |field| %>
            <%= field.hidden_field nil, value: @risk_assessment_form.products.first[:value] %>
          <% end %>
        <% end %>

        <%= form.govuk_file_upload :risk_assessment_file,
          hint: "This should usually be a PDF export from the RAPEX assessment tool",
          label: "Upload the risk assessment"
        %>

        <%= form.govuk_text_area :details,
          label: "Further details (optional)"
        %>

        <%= govukButton(text: "Add risk assessment") %>
      <% end %>

    </div>
  </div>



