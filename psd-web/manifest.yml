---
defaults: &defaults
  buildpacks:
    - ruby_buildpack
  memory: 1G
  instances: 1
  path: .
  stack: cflinuxfs3

web_defaults: &web_defaults
  command: export $(./env/get-env-from-vcap.sh) && STATEMENT_TIMEOUT=60s bin/rake cf:on_first_instance db:migrate keycloak:sync && bin/rails server -b 0.0.0.0 -p $PORT -e $RAILS_ENV
  services:
    - opss-log-drain
    - psd-aws-env
    - psd-auth-env
    - psd-database
    - psd-elasticsearch
    - psd-email-whitelist-env
    - psd-health-env
    - psd-keycloak-env
    - psd-notify-env
    - psd-pghero-env
    - psd-queue
    - psd-rails-env
    - psd-sentry-env
    - psd-session
    - psd-sidekiq-env

applications:
- name: psd-web
  <<: *defaults
  <<: *web_defaults
- name: psd-web-temp # Used temporarily for blue/green deployments
  <<: *defaults
  <<: *web_defaults
- name: psd-worker
  <<: *defaults
  no-route: true
  health-check-type: process
  command: export $(./env/get-env-from-vcap.sh) && bin/sidekiq -C config/sidekiq.yml
  services:
    - psd-database
    - psd-elasticsearch
    - psd-session
    - psd-queue
    - opss-log-drain
    - antivirus-auth-env
    - psd-aws-env
    - psd-notify-env
    - psd-rails-env
    - psd-sentry-env
    - psd-keycloak-env
